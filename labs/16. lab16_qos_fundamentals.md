# Quality of Service (QoS) Fundamentals

When it comes to your computer, the Task Manager is your immediate response when an application hangs or becomes unresponsive. You can “end a task” (application), freeing up your computer’s resources to apply to other applications. Similarly, **Quality of Service (QoS)** refers to tools that networking devices use to treat packets on the network differently as they pass through a device. Both act as the “managers” of resources, determining what is and isn’t important based on prioritization.

In this lab, we’ll explore how network devices identify, classify, and prioritize traffic using QoS mechanisms. The CCNA doesn’t go into QoS in depth. Conceptually, making this is a perfect opportunity to apply these ideas of QoS for the homelab.

For this lab, we will go over:

1. **Understanding QoS**
2. **Three Main QoS Models**
3. **Classification and Marking**
4. **Queue Behavior**
5. **Traffic Shaping and Policing**
6. **Congestion Avoidance**
7. **Wrap-Up**

## **Understanding QoS**

If we treated all traffic equally, our idea of phone calls, video calls, and interactive traffic would struggle to work effectively. This concept is called **Best Effort Delivery**, meaning there are no guarantees that traffic will be delivered reliably. This comes to our main idea of QoS: all traffic on a network is not equal, and we need to prioritize it. 

There are four characteristics of network traffic:

- **Bandwidth** - The speed/capacity of a link, and how many bits per second can be sent.
- **Delay** - The time it takes to send/receive packets back, to and from a host.
- **Jitter** - Variation in one-way delay between two applications.
- **Loss** - Total number of lost packets (usually a percentage).

Let’s take a look at the different types of traffic that QoS should affect on a network:

| **Traffic Type** | **Sensitivity** | **Example** |
| --- | --- | --- |
| Voice | Delay & Jitter | VoIP Phones |
| Video | Delay & Loss | Zoom, FaceTime |
| Critical Data | Loss | Database Traffic |
| Best Effort | None | Web Browsing, Email |

With a better understanding of how different types of traffic are affected by their sensitivity to traffic characteristics, we can see why QoS is crucial for ensuring reliable delivery of priority traffic on the network. Let’s now take a look at the different QoS models there are and how they may or may not apply to networks today.

## **Three Main QoS Models**

Right now, there are three different QoS models: **Best Effort**, **Integrated Services (IntServ)**, and **Differentiated Services (DiffServ)**. Let me explain the differences between these models:

- **Best Effort**: Providing no QoS, packets are treated the same with no bounds on delay, jitter, or loss.
- **Integrated Services (IntServ)**: Great for resource reservation, allowing specific amounts of bandwidth using the protocol **Resource Reservation Protocol (RSVP)**. Not scalable, so it isn’t used much today.
- **Differentiated Services (DiffServ)**: A modern, scalable, and flexible model that classifies traffic into different classes using the **Differentiated Services Code Points (DSCP)** protocol to mark packets.

Here’s a summary table comparing each of the QoS models:

| **Model** | **Description** | **Example** |
| --- | --- | --- |
| Best-Effort | No QoS - traffic is treated equally. | Default Networks |
| Integrated Services (IntServ) | Per-flow Reservations using RSVP | Older VoIP/Legacy WAN |
| Differentiated Services (DiffServ) | Traffic marked and prioritized by DSCP | Modern Enterprise Networks |

Since DiffServ is the most utilized QoS model today, and the main focal point of the CCNA, we will use this model for further QoS concepts. Let’s take a look next at how marking works with DiffServ.

## **Classification and Marking**

DiffServ utilizes classification and marking to classify packets, based on their header contents, and then marks them by changing bits in their specified header:

- **Classification**: The process of matching fields in a message to make a QoS action.
    - Similar to how an ACL matches packet headers (classify), and then has the action to choose if a packet needs to be discarded.
- **Marking**: QoS tools will change one or more header fields, setting a value in the header to differentiate the packet for QoS processing.

The way that DiffServ does it is by DSCP (IP marking) and CoS (Ethernet marking) for Layer 3 and Layer 2, respectively. Let’s take a look at each concept next:

### CoS Marking

Existing in the 802.1Q header, only existing on trunked links, we have the fields that make up the Ethernet frame:

- **Class of Service (CoS)**: Sitting in the third byte of the 4-byte 802.1Q header, CoS supplies eight possible values to mark.

Here’s a look at an Ethernet frame with the 802.1Q header:

<center>
  <img width="700" height="400" alt="802.1q_header" class="center" src="https://github.com/user-attachments/assets/c06855bd-b832-4fb6-9b66-dd00de865c70" />
</center>

- Inside the frame, we have the two main fields:
    - **Tag Protocol Identifier (TPID)**
    - **Tag Control Information (TCI)**
    

- The TCI is a 2-byte, or 16-bit field that is comprised of these three fields:
    - **Priority Code Point (PCP)**
    - **Drop Eligible Indicator (DEI)**
    - **VLAN Identifier (VLAN ID)**

Without going into major depth, PCP is a 3-bit field that is utilized to mark IP packet headers for CoS. Depending on the packet value determines what type of priority is given to the Ethernet frame entirely. However, what if we’re not traveling over an 802.1Q link? That’s where QoS marking on the Layer 3 comes into play.

### DSCP Marking

Offering a more persistent marking strategy from source to destination, let’s see how Layer 3 offers CoS:

Inside the IPv4 packet, we have the 8-bit Type of Service (ToS) field. Inside houses:

- **IP Precedence (IPP)**: A 3-bit field that is used for marking. IPP values are 0-7, determining different traffic classes of service.
    - Keep in mind that DSCP has redefined the ToS field, making IPP obsolete.

Here’s a look at an IPv4 Packet with the ToS field:

<center>
  <img width="700" height="400" alt="ipv4_packet" class="center" src="https://github.com/user-attachments/assets/fd300f9e-fdda-4866-9c80-ce484abadeb7" />
</center>

Below the IPP field are the 8-bit DiffServ fields. Made up of the following:

- **Explicit Congestion Notification (ECN)**: A 2-bit field used to determine the Flow Control (windowing) of TCP connections to prevent packet loss.
- **Differentiated Services Code Point (DSCP)**: A 6-bit field in the IP header used to mark a value in the header for the purpose of performing QoS actions on the packet.

All in all, both CoS and DSCP help with marking at Layer 2 and Layer 3. Mostly trying to help the routers know how to treat each packet like cars on the highway exiting at their correct exit ramp.

### **Trust Boundaries**

Now that we understand CoS and DSCP, knowing where in our network they should explicitly be trusted and not trusted is important. This especially applies to end-hosts. 

- **Trust Boundaries**: The point in the path a packet can trust the current QoS markings.

For instance, if voice is the most prioritized traffic in our network, we wouldn’t want a user to be able to adjust the DSCP of their traffic to match voice, so they get better QoS treatment.

Here is a perfect example of how Trust Boundaries are set:

<center>
  <img width="700" height="400" alt="trust_boundry" class="center" src="https://github.com/user-attachments/assets/9970d572-ab18-4dd1-91de-043e5ba5942d" />
</center>

- The first device could be an access switch or even a VoIP phone, just as long as it's configured to trust the egress traffic and set the values for CoS and DSCP.

Knowing the line between what devices we trust and don’t trust for configuration changes matters, and it especially matters for QoS.

### Marking Values

We won't get into the actual marking configuration in this lab (or the CCNA), but we can take a look at the three sets of DSCP values that are adjusted in DiffServ next.

**Expedited Forwarding (EF)**

Our first DSCP value we will look at is:

- **Expedited Forwarding (EF)**: A single value used for packets that need low latency (delay), low jitter, and low loss (DSCP value is decimal 46).

This one is pretty self-explanatory; we want traffic sent as quickly and efficiently as possible without any hiccups along the way. A great example of this in practice is voice traffic.

**Assured Forwarding (AF)**

Now, we’ll need to visualize how different traffic is prioritized by what’s considered the most and least valued traffic:

- **Assured Forwarding (AF)**:  Defined as a set of 12 DSCP values, with four separate queues and three levels of drop priority within each queue.

This one is a bit easier to understand with a table:

<center>
  <img width="700" height="400" alt="assured_forwarding" class="center" src="https://github.com/user-attachments/assets/8525c947-9e67-4174-8374-833508f026d7" />
</center>

- The AF table above is structed as AFXY, where X refers to the queue (1 through 4) and Y, refers to the the drop priority (1 through 3).

For example. AF11, AF12, and AF13 are all part of a queue; AF21, AF22, and AF23 and apart of another and so on. As well as treating AF11, AF21, etc. with preferred drop treatment (not as dropped), while AF13, AF23, etc. is treated with the worst drop treatment (most dropped). It really depends on he congestion avoidance drop actions that we will get into later in this lab.

**Class Selector (CS)**

Lastly, we have our last DSCP value:

- **Class Selector (CS)**: A method to classify traffic by it’s DSCP values, which are backward-compatible with the older IPP model.

Remember, IPP has been replaced with DSCP, but CS will take the IPP’s 3-bit values. Let’s take a look at how the IPv4 DSCP field uses the IPP values with the CS:

<center>
  <img width="700" height="400" alt="class_sector" class="center" src="https://github.com/user-attachments/assets/41b5b226-a132-4361-adb3-4f05ddb55f7f" />
</center>

| **IPP** | **CS** | **Decimal DSCP** | **IPP Names** |
| --- | --- | --- | --- |
| 000 | CS0 | 000000 | Routine  |
| 001 | CS1 | 001000 | Priority |
| 010 | CS2 | 010000 | Immediate |
| 011 | CS3 | 011000 | Flash |
| 100 | CS4 | 100000 | Flash Override |
| 101 | CS5 | 10100 | Critic/Critical |
| 110 | CS6 | 110000 | Internetwork Control |
| 111 | CS7 | 111000 | Network Control |

We will build upon these concepts in classification and marking with the rest of the lab, seeing how traffic is prioritized on based on queueing, policy, shaping, and congestion avoidance. Next, up, let’s see if we can implement both QoS on the homelab devices as well as configuring a priority marking configuration.
